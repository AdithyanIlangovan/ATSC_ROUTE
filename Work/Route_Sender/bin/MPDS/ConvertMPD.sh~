#!/bin/bash

#This script is intended to transform static MPD generated by MP4BOX to dynamic. This is done by:
#1- Change type="static" to type="dynamic"
#2- Add availabilityStartTime at MPD level
#3- Set Period ids incrementally in case they are empty

if [ $# -ne 3 ]
then
	echo "Usage: ./ConvertMPD.sh MPDName VideoRepresentationID AudioRepresentationID"
	exit
fi 

period=1;	#This is used to incrementally set periods in MPD
toPrint=1;	#This is used to generate new MPD with only 1 video and 1 audio representation.
		#It assumes that audio and video are in seperate adaptation sets

a=$(awk -v startTime="$(date +"%Y-%m-%dT%T" --date='5 seconds')" -v period=$period -v toPrint=$toPrint -v MPDName=$1 -v vidRepID=$2 -v audRepID=$3 'BEGIN {value="";gsub(/\./,"_Dynamic.",MPDName)} {sub(/type="static"/,"type=\"dynamic\" availabilityStartTime=\""startTime"\" timeShiftBufferDepth=\"PT10S\"");if ($1=="<Period") {sub(/id=""/,"id=\""period"\""); period++}; if (($1=="<Representation" && index($0,"id=\""vidRepID"\"") == 0 && index($0,"mimeType=\"video") > 0) ||($1=="<Representation" && index($0,"id=\""audRepID"\"") == 0 && index($0,"mimeType=\"audio") > 0)) toPrint=0;if (toPrint==1) {for (i=NF-1;i>1;i--) if (index($i,"timescale=") > 0 || index($i,"duration=") > 0) {value=$i;gsub(/[a-z,A-Z,=,"]/,"",value); print value} else if (index($i,"media=") > 0) {value=$i;gsub(/\$Number\$\.mp4/,"",value); print value};print $0 > MPDName}; if (index($0,"</Representation") > 0) toPrint=1}' $1)

info=($a);			# The array contains: SegmentsName followed by duration and then timescale
				# Duration(seconds) = duration/timescale
echo ${info[0]};		#First Representation
echo ${info[1]};		#First Rep's duration
echo ${info[2]};		#First Rep's timescale
echo ${info[3]};		#Second Representation
echo ${info[4]};		#Second Rep's duration
echo ${info[5]};		#Second Rep's timescale

interval_video=$((${info[1]}/${info[2]}))
test_remainder=$((${info[1]}%${info[2]}))

if [ $test_remainder -ne 0 ] 
then
	$interval_video+1;
fi
echo "Time interval for the Video representation is $interval_video"

interval_audio=$((${info[4]}/${info[5]}))
test_remainder=$((${info[4]}%${info[5]}))

if [ $test_remainder -ne 0 ]
then
	interval_audio=$(($interval_audio+1));
fi
echo "Time interval for the audio representation is $interval_audio"

echo ${info[0]:7:-1}
echo ${info[3]:7:-1}

cd /root/Documents/mad_fcl_v1.7_linux_bin/
./start_broadcast_service.sh -P server_files/1b_1M_test -p 4000 -D 224.1.1.1 -r 1000 -v $interval_video -a $interval_audio -L ${info[0]} -l ${info[3]}


